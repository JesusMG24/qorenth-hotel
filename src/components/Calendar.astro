---
const { t } = Astro.props;

const translations = {
  calendarSelectCheckin: t("calendar.select.checkin"),
  calendarSelectCheckout: t("calendar.select.checkout"),
  months: [
    t("calendar.months.january"),
    t("calendar.months.february"),
    t("calendar.months.march"),
    t("calendar.months.april"),
    t("calendar.months.may"),
    t("calendar.months.june"),
    t("calendar.months.july"),
    t("calendar.months.august"),
    t("calendar.months.september"),
    t("calendar.months.october"),
    t("calendar.months.november"),
    t("calendar.months.december"),
  ],
};
---

<style>
  html,
  body {
    overflow-x: hidden;
  }

  #calendar-modal {
    transition:
      opacity 0.2s ease,
      visibility 0.2s ease;
  }
</style>

<!-- Date Selector Container -->
<div
  id="date-container"
  class="w-full xl:w-max flex justify-center border-b md:border-none border-black py-3 px-4 sm:px-6 md:px-8 xl:px-10 overflow-x-hidden"
>
  <button
    id="calendar-btn"
    class="flex items-center gap-2 text-gray-600 hover:text-yellow-600 cursor-pointer border border-gray-300 rounded px-4 py-2 bg-white shadow-sm transition-colors"
  >
    <svg
      class="w-5 h-5 text-gray-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
      ></path>
    </svg>
    <span id="calendar-btn-label" class="text-sm font-semibold"></span>
  </button>
</div>

<!-- Calendar Modal -->
<div
  id="calendar-modal"
  class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden z-50 items-center justify-center"
>
  <div
    class="bg-white rounded-lg p-6 max-w-md w-full mx-4 sm:mx-auto shadow-xl"
  >
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h3 id="calendar-title" class="font-semibold">
        {t("calendar.select.date")}
      </h3>
      <button id="close-calendar" class="text-gray-500 hover:text-gray-700">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Month Navigation -->
    <div class="flex justify-between items-center mb-4">
      <button id="prev-month" class="p-2 hover:bg-gray-100 rounded">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <h4 id="calendar-month-year" class="text-lg font-semibold"></h4>
      <button id="next-month" class="p-2 hover:bg-gray-100 rounded">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>

    <!-- Weekdays -->
    <div
      class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-medium text-gray-500"
    >
      <div>{t("calendar.days.su")}</div>
      <div>{t("calendar.days.mo")}</div>
      <div>{t("calendar.days.tu")}</div>
      <div>{t("calendar.days.we")}</div>
      <div>{t("calendar.days.th")}</div>
      <div>{t("calendar.days.fr")}</div>
      <div>{t("calendar.days.sa")}</div>
    </div>

    <!-- Calendar Days -->
    <div id="calendar-grid" class="grid grid-cols-7 gap-1 mb-4"></div>

    <!-- Actions -->
    <div class="mt-6 flex gap-3">
      <button
        id="calendar-cancel"
        class="flex-1 py-2 px-4 border border-gray-300 rounded-md hover:bg-gray-100 transition"
      >
        {t("calendar.cancel")}
      </button>
      <button
        id="calendar-confirm"
        class="flex-1 py-2 px-4 bg-black text-white rounded-md hover:bg-yellow-600 transition"
      >
        {t("calendar.confirm")}
      </button>
    </div>
  </div>
</div>

<script is:inline define:vars={{ translations }}>
  let currentCalendarDate = new Date();
  let selectedDate = null;
  let isSelectingCheckin = true;
  let checkinDate = new Date();
  let checkoutDate = new Date(Date.now() + 24 * 60 * 60 * 1000);

  const modal = document.getElementById("calendar-modal");
  const title = document.getElementById("calendar-title");
  const monthYear = document.getElementById("calendar-month-year");
  const grid = document.getElementById("calendar-grid");
  const prevBtn = document.getElementById("prev-month");
  const nextBtn = document.getElementById("next-month");
  const closeBtn = document.getElementById("close-calendar");
  const confirmBtn = document.getElementById("calendar-confirm");
  const cancelBtn = document.getElementById("calendar-cancel");
  const openBtn = document.getElementById("calendar-btn");
  const label = document.getElementById("calendar-btn-label");

  function updateDisplay() {
    const options = { month: "short", day: "numeric" };
    const ci = checkinDate.toLocaleDateString(undefined, options);
    const co = checkoutDate.toLocaleDateString(undefined, options);
    label.textContent = `${ci} â€“ ${co}`;
  }

  function renderCalendar() {
    const y = currentCalendarDate.getFullYear();
    const m = currentCalendarDate.getMonth();
    const first = new Date(y, m, 1);
    const last = new Date(y, m + 1, 0);
    const startDay = first.getDay();
    const days = last.getDate();

    monthYear.textContent = `${translations.months[m]} ${y}`;
    grid.innerHTML = "";

    for (let i = 0; i < startDay; i++) {
      grid.appendChild(document.createElement("div"));
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let d = 1; d <= days; d++) {
      const btn = document.createElement("button");
      const date = new Date(y, m, d);
      btn.textContent = d;
      btn.className =
        "h-8 w-8 text-sm rounded flex items-center justify-center transition";

      if (date < today) {
        btn.disabled = true;
        btn.classList.add("text-gray-300", "cursor-not-allowed");
      } else {
        if (isSelected(date))
          btn.classList.add("bg-black", "text-white", "hover:bg-yellow-600");
        else if (isInRange(date))
          btn.classList.add("bg-yellow-100", "hover:bg-yellow-200");
        else btn.classList.add("hover:bg-gray-100");

        btn.addEventListener("click", () => {
          selectedDate = new Date(date);
          if (isSelectingCheckin) {
            checkinDate = new Date(selectedDate);
            if (checkoutDate <= checkinDate) {
              checkoutDate = new Date(checkinDate);
              checkoutDate.setDate(checkoutDate.getDate() + 1);
            }
            isSelectingCheckin = false;
          } else {
            if (selectedDate <= checkinDate) {
              checkoutDate = new Date(checkinDate);
              checkinDate = new Date(selectedDate);
              checkoutDate.setDate(checkoutDate.getDate() + 1);
            } else {
              checkoutDate = new Date(selectedDate);
            }
            isSelectingCheckin = true;
          }
          renderCalendar();
        });
      }

      grid.appendChild(btn);
    }
  }

  function isSelected(date) {
    return (
      date.getTime() === checkinDate.getTime() ||
      date.getTime() === checkoutDate.getTime()
    );
  }

  function isInRange(date) {
    return date > checkinDate && date < checkoutDate;
  }

  function saveToStorage() {
    localStorage.setItem("checkin", checkinDate.toISOString());
    localStorage.setItem("checkout", checkoutDate.toISOString());
  }

  openBtn.addEventListener("click", () => {
    isSelectingCheckin = true;
    title.textContent = translations.calendarSelectCheckin;
    currentCalendarDate = new Date(checkinDate);
    renderCalendar();
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  });

  [closeBtn, cancelBtn].forEach((btn) =>
    btn.addEventListener("click", closeModal)
  );
  confirmBtn.addEventListener("click", () => {
    updateDisplay();
    saveToStorage();
    closeModal();
  });

  modal.addEventListener("click", (e) => {
    if (e.target.id === "calendar-modal") closeModal();
  });

  prevBtn.addEventListener("click", () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
  });
  nextBtn.addEventListener("click", () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
  });

  function closeModal() {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    isSelectingCheckin = true;
  }

  function restoreFromStorage() {
    const ci = localStorage.getItem("checkin");
    const co = localStorage.getItem("checkout");
    if (ci && co) {
      checkinDate = new Date(ci);
      checkoutDate = new Date(co);
    }
    updateDisplay();
  }

  restoreFromStorage();
</script>
