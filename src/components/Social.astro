---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section class="bg-[#efe5d8] flex flex-col items-center p-5 md:py-15 xl:mt-5">
  <div class="md:flex md:w-full md:justify-between xl:w-225">
    <h2 class="md:text-xl">{t("social.instagram.title")}</h2>
    <a href="https://www.instagram.com/" target="_blank" class="underline">
      {t("social.instagram.handle")}
    </a>
  </div>

  <div class="relative w-full max-w-4xl mx-auto mt-4">
    <div class="carousel-container overflow-hidden rounded-lg">
      <div
        class="carousel-track flex md:gap-3 transition-transform duration-300 ease-in-out"
      >
        <img
          src="/images/social1.jpg"
          class="w-full md:w-1/3 h-64 md:h-80 object-cover shrink-0"
          alt="Instagram post 1"
        />
        <img
          src="/images/social2.jpg"
          class="w-full md:w-1/3 h-64 md:h-80 object-cover shrink-0"
          alt="Instagram post 2"
        />
        <img
          src="/images/social3.jpg"
          class="w-full md:w-1/3 h-64 md:h-80 object-cover shrink-0"
          alt="Instagram post 3"
        />
        <img
          src="/images/social4.jpg"
          class="w-full md:w-1/3 h-64 md:h-80 object-cover shrink-0"
          alt="Instagram post 4"
        />
        <img
          src="/images/social5.jpg"
          class="w-full md:w-1/3 h-64 md:h-80 object-cover shrink-0"
          alt="Instagram post 5"
        />
      </div>
    </div>

    <button
      class="carousel-prev absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors md:aspect-square md:w-15 md:text-4xl"
      aria-label="Previous image">←</button
    >
    <button
      class="carousel-next absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors md:aspect-square md:w-15 md:text-4xl"
      aria-label="Next image">→</button
    >

    <div class="flex justify-center mt-4 space-x-2 md:hidden">
      <button
        class="carousel-dot w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-600 transition-colors"
        data-index="0"></button>
      <button
        class="carousel-dot w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-600 transition-colors"
        data-index="1"></button>
      <button
        class="carousel-dot w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-600 transition-colors"
        data-index="2"></button>
      <button
        class="carousel-dot w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-600 transition-colors"
        data-index="3"></button>
      <button
        class="carousel-dot w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-600 transition-colors"
        data-index="4"></button>
    </div>
  </div>
</section>

<script>
  class InstagramCarousel {
    private currentIndex = 0;
    private totalImages = 5;
    private track: HTMLElement;
    private dots: NodeListOf<HTMLElement>;

    constructor() {
      this.track = document.querySelector(".carousel-track") as HTMLElement;
      this.dots = document.querySelectorAll(
        ".carousel-dot"
      ) as NodeListOf<HTMLElement>;
      this.init();
      window.addEventListener("resize", () => this.updateCarousel());
    }

    private init() {
      document
        .querySelector(".carousel-prev")
        ?.addEventListener("click", () => this.goToPrevious());
      document
        .querySelector(".carousel-next")
        ?.addEventListener("click", () => this.goToNext());
      this.dots.forEach((dot, i) =>
        dot.addEventListener("click", () => this.goToSlide(i))
      );
      this.updateCarousel();
      this.startAutoPlay();
    }

    private getVisibleSlides() {
      return window.innerWidth >= 768 ? 3 : 1; // Tailwind md breakpoint = 768px
    }

    private goToPrevious() {
      const visible = this.getVisibleSlides();
      this.currentIndex =
        this.currentIndex === 0
          ? this.totalImages - visible
          : this.currentIndex - 1;
      this.updateCarousel();
    }

    private goToNext() {
      const visible = this.getVisibleSlides();
      this.currentIndex =
        this.currentIndex >= this.totalImages - visible
          ? 0
          : this.currentIndex + 1;
      this.updateCarousel();
    }

    private goToSlide(index: number) {
      this.currentIndex = index;
      this.updateCarousel();
    }

    private updateCarousel() {
      const visible = this.getVisibleSlides();
      const translateX = -(this.currentIndex * (100 / visible));
      this.track.style.transform = `translateX(${translateX}%)`;

      this.dots.forEach((dot, i) => {
        if (i === this.currentIndex) {
          dot.classList.replace("bg-gray-400", "bg-gray-800");
        } else {
          dot.classList.replace("bg-gray-800", "bg-gray-400");
        }
      });
    }

    private startAutoPlay() {
      setInterval(() => this.goToNext(), 4000);
    }
  }

  document.addEventListener("DOMContentLoaded", () => new InstagramCarousel());
</script>
